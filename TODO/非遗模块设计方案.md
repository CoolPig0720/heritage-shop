# 非遗模块设计方案

## 1. 模块概述

非遗模块用于展示非物质文化遗产相关内容，包含：
- 非遗项目分类（大类/子类）
- 非遗项目列表与详情（文字介绍 + 工艺流程图 + 视频）
- 非遗传承人列表与详情（并展示其关联项目）
- 管理端非遗内容维护（项目/传承人/分类 + 项目媒体上传与删除）

模块核心目标是支撑 3 个页面：
1. 非遗项目列表页（筛选 + 统计 + 表格展示）
2. 非遗项目详情页（项目基础信息 + 介绍 + 流程图/视频 + 相关传承人）
3. 传承人详情页（传承人信息 + 介绍 + 关联项目）

---

## 2. 需求分析

### 2.1 功能需求

1. **分类展示**
   - 展示非遗项目大类（支持树形结构，`parent_id` 可选用）

2. **项目列表展示（对应原型图1）**
   - 支持按所属地区、公布时间、类别、类型、关键词筛选
   - 支持分页
   - 支持展示统计数据（批次/类别/项目/子项），可先用接口聚合返回或前端 mock

3. **项目详情展示（对应原型图2）**
   - 展示项目基础信息与详细介绍（文本）
   - 展示工艺流程图片（多张，按排序）
   - 展示视频（可选）
   - 展示相关传承人列表
   - 管理端入口进入时支持上传/删除：展示图、工艺流程图、工艺视频

4. **传承人详情展示（对应原型图3）**
   - 展示传承人基础信息（姓名、性别、出生日期、民族、照片）
   - 展示传承人详细介绍
   - 展示其关联项目列表

### 2.2 非功能需求

1. **可扩展性**
   - 支持一个项目关联多个传承人、一个传承人关联多个项目（多对多）
   - 支持为同一项目配置多种媒体资源（展示图/流程图/视频）

2. **性能**
   - 列表查询支持索引
   - 分类树可缓存

3. **一致性**
   - 媒体展示顺序由 `sort_order` 控制，避免前端硬编码

---

## 3. 数据库设计

### 3.1 表清单（最终落地版）

共 5 张表：
```
heritage_category
heritage_project
heritage_project_media
heritage_inheritor
heritage_project_inheritor
```

约束规则：
- 表名不使用 `t_` 前缀
- 不使用 `create_time`
- 保留 `parent_id`
- 保留 `media_type`
- 保留 `sort_order`

### 3.2 非遗分类表 `heritage_category`

| 字段名        | 类型        | 长度  | 允许空 | 默认值  | 说明          |
| ---------- | --------- | --- | --- | ---- | ----------- |
| id         | BIGINT PK | -   | 否   | -    | 分类ID        |
| name       | VARCHAR   | 100 | 否   | -    | 分类名称        |
| parent_id  | BIGINT    | -   | 是   | NULL | 父级分类ID（可不用） |
| sort_order | INT       | -   | 否   | 0    | 排序          |

**索引设计：**
- PRIMARY KEY (`id`)
- KEY `idx_parent_id` (`parent_id`)

### 3.3 非遗项目主表 `heritage_project`

| 字段名          | 类型        | 长度  | 允许空 | 默认值 | 说明     |
| ------------ | --------- | --- | --- | --- | ------ |
| id           | BIGINT PK | -   | 否   | -   | 项目ID   |
| category_id  | BIGINT    | -   | 否   | -   | 分类ID   |
| name         | VARCHAR   | 200 | 否   | -   | 项目名称   |
| description  | TEXT      | -   | 否   | -   | 项目详细介绍 |
| apply_unit   | VARCHAR   | 200 | 否   | -   | 申报单位   |
| protect_unit | VARCHAR   | 200 | 否   | -   | 保护单位   |

**索引设计：**
- PRIMARY KEY (`id`)
- KEY `idx_category_id` (`category_id`)

### 3.4 非遗项目多媒体表 `heritage_project_media`

| 字段名        | 类型        | 长度  | 允许空 | 默认值 | 说明   |
| ---------- | --------- | --- | --- | --- | ---- |
| id         | BIGINT PK | -   | 否   | -   | 媒体ID |
| project_id | BIGINT    | -   | 否   | -   | 项目ID |
| media_type | VARCHAR   | 50  | 否   | -   | 媒体类型 |
| media_url  | VARCHAR   | 255 | 否   | -   | 资源地址 |
| sort_order | INT       | -   | 否   | 0   | 排序   |

**media_type 推荐值：**
```
DISPLAY_IMAGE   展示图
PROCESS_IMAGE   工艺流程图
VIDEO           视频
```

**索引设计：**
- PRIMARY KEY (`id`)
- KEY `idx_project_id` (`project_id`)
- KEY `idx_project_type` (`project_id`, `media_type`)

### 3.5 非遗传承人表 `heritage_inheritor`

| 字段名         | 类型        | 长度  | 允许空 | 默认值  | 说明    |
| ----------- | --------- | --- | --- | ---- | ----- |
| id          | BIGINT PK | -   | 否   | -    | 传承人ID |
| name        | VARCHAR   | 100 | 否   | -    | 姓名    |
| gender      | VARCHAR   | 10  | 否   | -    | 性别    |
| birth_date  | DATE      | -   | 是   | NULL | 出生日期  |
| nation      | VARCHAR   | 50  | 是   | NULL | 民族    |
| photo       | VARCHAR   | 255 | 是   | NULL | 照片    |
| description | TEXT      | -   | 是   | NULL | 详细介绍  |

**索引设计：**
- PRIMARY KEY (`id`)
- KEY `idx_name` (`name`)

### 3.6 项目-传承人关系表 `heritage_project_inheritor`

| 字段名          | 类型        | 长度 | 允许空 | 默认值 | 说明    |
| ------------ | --------- | -- | --- | --- | ----- |
| id           | BIGINT PK | -  | 否   | -   | 主键    |
| project_id   | BIGINT    | -  | 否   | -   | 项目ID  |
| inheritor_id | BIGINT    | -  | 否   | -   | 传承人ID |

**索引设计：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_project_inheritor` (`project_id`, `inheritor_id`)
- KEY `idx_project_id` (`project_id`)
- KEY `idx_inheritor_id` (`inheritor_id`)

---

## 4. 后端架构设计

### 4.1 实体层

实体与表对应：
- `HeritageCategory` -> `heritage_category`
- `HeritageProject` -> `heritage_project`
- `HeritageProjectMedia` -> `heritage_project_media`
- `HeritageInheritor` -> `heritage_inheritor`
- `HeritageProjectInheritor` -> `heritage_project_inheritor`

### 4.2 数据访问层（Mapper）

使用 MyBatis-Plus：
- `HeritageCategoryMapper extends BaseMapper<HeritageCategory>`
- `HeritageProjectMapper extends BaseMapper<HeritageProject>`
- `HeritageProjectMediaMapper extends BaseMapper<HeritageProjectMedia>`
- `HeritageInheritorMapper extends BaseMapper<HeritageInheritor>`
- `HeritageProjectInheritorMapper extends BaseMapper<HeritageProjectInheritor>`

### 4.3 数据传输层（DTO / VO）

1. **列表查询 DTO**
   - 支持：地区/公布时间/类别/类型/关键词/分页参数

2. **项目详情 VO**
   - 基础信息：项目名称、分类、申报单位、保护单位等
   - 媒体信息：展示图、流程图、视频（按 `media_type` 分组，按 `sort_order` 排序）
   - 相关传承人：传承人简要信息列表

3. **传承人详情 VO**
   - 基础信息：姓名、性别、出生日期、民族、照片
   - 详细介绍
   - 关联项目列表（可返回项目 id + 名称 + 分类）

### 4.4 Service 层

建议拆分：
- `HeritageCategoryService`：分类树与分类信息
- `HeritageProjectService`：列表查询与详情聚合（项目 + 媒体 + 传承人）
- `HeritageInheritorService`：传承人详情聚合（传承人 + 关联项目）

### 4.5 控制器层（公开展示接口）

建议路由前缀：
`/api/heritage`

接口清单：
- GET `/api/heritage/categories/tree`
- GET `/api/heritage/projects`
- GET `/api/heritage/projects/{id}`
- GET `/api/heritage/inheritors/{id}`

管理端接口清单（管理员）：
- GET `/api/admin/heritage/categories/tree`
- POST `/api/admin/heritage/categories`
- GET `/api/admin/heritage/projects`
- GET `/api/admin/heritage/projects/{id}`
- POST `/api/admin/heritage/projects`
- PUT `/api/admin/heritage/projects/{id}`
- PUT `/api/admin/heritage/projects/{id}/inheritors`
- POST `/api/admin/heritage/projects/{id}/medias`
- PUT `/api/admin/heritage/projects/medias/{mediaId}`
- DELETE `/api/admin/heritage/projects/medias/{mediaId}`
- DELETE `/api/admin/heritage/projects/{id}`
- GET `/api/admin/heritage/inheritors`
- GET `/api/admin/heritage/inheritors/{id}`
- POST `/api/admin/heritage/inheritors`
- PUT `/api/admin/heritage/inheritors/{id}`
- DELETE `/api/admin/heritage/inheritors/{id}`

---

## 5. 前端架构设计

### 5.1 API 接口封装

新增：
- `frontend/src/api/heritage.js`

### 5.2 页面组件

建议页面：
- `HeritageList.vue`：非遗项目列表页
- `HeritageProjectDetail.vue`：项目详情页
- `HeritageInheritorDetail.vue`：传承人详情页

展示逻辑要点：
- 列表页筛选参数与分页参数与后端对齐
- 项目详情页按 `media_type` 区分图片区块
- `sort_order` 控制媒体顺序，保证后端配置即可变更前端展示顺序

---

## 6. 业务流程

### 6.1 列表页流程

1. 页面加载：获取分类树（用于筛选下拉）
2. 用户设置筛选条件：调用项目分页查询接口
3. 用户点击项目：跳转项目详情页

### 6.2 项目详情页流程

1. 进入详情页：根据 id 拉取项目详情
2. 页面渲染：基础信息 + 介绍 + 流程图/视频 + 相关传承人
3. 用户点击传承人：跳转传承人详情页

管理端媒体维护流程：
1. 管理端进入项目详情：路由携带 `from=manage`
2. 上传文件：调用文件上传接口获取 `media_url`
3. 保存媒体：调用管理端项目媒体新增接口写入 `heritage_project_media`
4. 删除媒体：调用管理端项目媒体删除接口并刷新详情

### 6.3 传承人详情页流程

1. 进入详情页：根据 id 拉取传承人详情
2. 页面渲染：基础信息 + 介绍 + 关联项目列表
3. 用户点击关联项目：跳转项目详情页

---

## 7. 安全设计

- 非遗模块为展示型内容，默认开放匿名访问
- 管理端接口采用管理员鉴权（`/api/admin/heritage/**`，基于 `@PreAuthorize("hasRole('ADMIN')")`）

---

## 8. 注意事项

1. **媒体资源**：`media_url` 存储可访问 URL，统一走文件上传模块产出的路径
2. **排序规则**：媒体展示顺序严格按 `sort_order`（升序）
3. **多对多关系**：项目与传承人使用 `heritage_project_inheritor` 维护关联，避免冗余字段导致同步困难
