# 用户模块设计方案

## 1. 模块概述

用户模块是整个系统的基础模块，负责用户的注册、登录、认证、权限管理等核心功能。本模块支持三种用户角色：普通用户（USER）、商家（MERCHANT）、管理员（ADMIN）。

## 2. 需求分析

### 2.1 功能需求

1. **用户注册**
   - 用户通过账号、密码、名称、角色进行注册
   - 注册时需要填写账号、密码、确认密码、名称、角色
   - 账号唯一性校验
   - 密码强度校验

2. **用户登录**
   - 用户通过账号和密码登录
   - 登录成功后返回 JWT Token
   - Token 有效期 7 天

3. **实名认证**
   - 商家和普通用户需要进行实名认证
   - 证件表中预置了合法的证件号和对应的名称
   - 用户输入证件号和名称进行认证
   - 如果证件号和名称匹配，认证成功
   - 证件号唯一，一个证件号只能被一个用户使用
   - 管理员不需要实名认证

4. **个人信息管理**
   - 用户可以修改自己的名称、头像
   - 用户可以修改密码
   - 用户可以查看自己的认证信息

5. **用户管理（管理员）**
   - 管理员可以查看所有用户列表
   - 管理员可以修改用户状态（启用/禁用）
   - 管理员可以删除用户

### 2.2 非功能需求

1. **安全性**
   - 密码使用 BCrypt 加密存储
   - JWT Token 认证
   - 接口权限控制

2. **性能**
   - 使用 Redis 缓存用户信息
   - 数据库索引优化

3. **可扩展性**
   - 支持多种角色扩展
   - 支持多种认证方式扩展

## 3. 数据库设计

### 3.1 用户表 `user`

用户表存储用户的基本信息和认证信息。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | BIGINT | - | 否 | - | 用户ID，主键，自增 |
| account | VARCHAR | 50 | 否 | - | 账号，用于登录，唯一索引 |
| password | VARCHAR | 255 | 否 | - | 密码，BCrypt 加密 |
| name | VARCHAR | 50 | 否 | - | 名称，用户可修改 |
| role | VARCHAR | 20 | 否 | USER | 角色：ADMIN-管理员，USER-普通用户，MERCHANT-商家 |
| avatar | VARCHAR | 255 | 是 | - | 头像 URL |
| certificate_number | VARCHAR | 100 | 是 | - | 证件号，实名认证后填充，唯一索引 |
| register_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | 注册时间 |

**索引设计：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_account` (`account`)
- UNIQUE KEY `uk_certificate_number` (`certificate_number`)
- KEY `idx_role` (`role`)

**字段说明：**
- `account`：用户登录账号，4-20 位，字母数字下划线，全局唯一
- `password`：用户密码，8-20 位，至少包含字母和数字，使用 BCrypt 加密存储
- `name`：用户显示名称，2-20 位，中文或英文，用户可以自己修改
- `role`：用户角色，注册时选择，ADMIN（管理员）、USER（普通用户）、MERCHANT（商家）
- `avatar`：用户头像 URL，可为空
- `certificate_number`：证件号，实名认证后填充，可为空，全局唯一
- `register_time`：注册时间

### 3.2 证件表 `certificate`

证件表存储预置的合法证件信息，用于实名认证验证。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | BIGINT | - | 否 | - | 证件ID，主键，自增 |
| certificate_number | VARCHAR | 100 | 否 | - | 证件号，唯一索引 |
| name | VARCHAR | 50 | 否 | - | 真实姓名 |
| role | VARCHAR | 20 | 否 | - | 角色：USER-普通用户，MERCHANT-商家 |

**索引设计：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_certificate_number` (`certificate_number`)
- KEY `idx_role` (`role`)

**字段说明：**
- `certificate_number`：证件号，全局唯一
- `name`：真实姓名，与证件号一一对应
- `role`：证件对应的角色，USER 或 MERCHANT

### 3.3 证件号格式

证件号使用更真实的格式：

#### 3.3.1 商家证件号
- **格式**：`MERCHANT{序号}`
- **示例**：`MERCHANT001`、`MERCHANT002`、`MERCHANT003`
- **说明**：
  - `MERCHANT` 固定前缀
  - `001` 为 3 位序号，从 001 开始递增

#### 3.3.2 普通用户证件号
- **格式**：`USER{序号}`
- **示例**：`USER001`、`USER002`、`USER003`
- **说明**：
  - `USER` 固定前缀
  - `001` 为 3 位序号，从 001 开始递增

#### 3.3.3 管理员证件号
- **说明**：管理员不需要实名认证，因此没有证件号

### 3.4 实名认证流程

1. **用户提交认证**
   - 用户输入证件号和真实姓名
   - 系统在证件表中查找匹配的记录
   - 如果找到证件号和名称都匹配的记录，且该证件号未被其他用户使用，则认证成功
   - 认证成功后，将证件号更新到用户表的 certificate_number 字段
   - 如果证件号和名称不匹配，或证件号已被其他用户使用，则认证失败

2. **认证完成**
   - 用户可以在个人中心查看认证状态
   - 认证成功后，用户可以进行相应的业务操作（如商家发布商品）

## 4. 后端架构设计

### 4.1 实体层

#### 4.1.1 User 实体类

```java
@Data
@TableName("user")
public class User {
    @TableId(type = IdType.AUTO)
    private Long id;

    @TableField("account")
    private String account;

    @TableField("password")
    @JsonIgnore
    private String password;

    @TableField("name")
    private String name;

    @TableField("role")
    private String role;

    @TableField("avatar")
    private String avatar;

    @TableField("certificate_number")
    private String certificateNumber;

    @TableField(value = "register_time", fill = FieldFill.INSERT)
    private LocalDateTime registerTime;
}
```

#### 4.1.2 Certificate 实体类

```java
@Data
@TableName("certificate")
public class Certificate {
    @TableId(type = IdType.AUTO)
    private Long id;

    @TableField("certificate_number")
    private String certificateNumber;

    @TableField("name")
    private String name;

    @TableField("role")
    private String role;
}
```

### 4.2 数据访问层

#### 4.2.1 UserMapper

```java
@Mapper
public interface UserMapper extends BaseMapper<User> {
}
```

#### 4.2.2 CertificateMapper

```java
@Mapper
public interface CertificateMapper extends BaseMapper<Certificate> {
}
```

### 4.3 数据传输层（DTO）

#### 4.3.1 登录请求

```java
@Data
public class LoginRequest {
    @NotBlank(message = "账号不能为空")
    private String account;

    @NotBlank(message = "密码不能为空")
    private String password;
}
```

#### 4.3.2 注册请求

```java
@Data
public class RegisterRequest {
    @NotBlank(message = "账号不能为空")
    @Pattern(regexp = "^[a-zA-Z0-9_]{4,20}$", message = "账号必须是4-20位字母、数字或下划线")
    private String account;

    @NotBlank(message = "密码不能为空")
    @Pattern(regexp = "^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d]{8,20}$", message = "密码必须是8-20位，至少包含字母和数字")
    private String password;

    @NotBlank(message = "确认密码不能为空")
    private String confirmPassword;

    @NotBlank(message = "名称不能为空")
    @Length(min = 2, max = 20, message = "名称长度必须在2-20位之间")
    private String name;

    @NotBlank(message = "角色不能为空")
    private String role;
}
```

#### 4.3.3 用户信息返回

```java
@Data
public class UserVO {
    private Long id;
    private String account;
    private String name;
    private String role;
    private String avatar;
    private String certificateNumber;
    private LocalDateTime registerTime;
}
```

#### 4.3.4 用户信息更新

```java
@Data
public class UserUpdateRequest {
    @Length(min = 2, max = 20, message = "名称长度必须在2-20位之间")
    private String name;

    private String avatar;
}
```

#### 4.3.5 密码修改

```java
@Data
public class PasswordUpdateRequest {
    @NotBlank(message = "原密码不能为空")
    private String oldPassword;

    @NotBlank(message = "新密码不能为空")
    @Pattern(regexp = "^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d]{8,20}$", message = "密码必须是8-20位，至少包含字母和数字")
    private String newPassword;

    @NotBlank(message = "确认密码不能为空")
    private String confirmPassword;
}
```

#### 4.3.6 实名认证请求

```java
@Data
public class CertificateRequest {
    @NotBlank(message = "证件号不能为空")
    private String certificateNumber;

    @NotBlank(message = "真实姓名不能为空")
    @Length(min = 2, max = 20, message = "姓名长度必须在2-20位之间")
    private String name;
}
```

### 4.4 业务逻辑层

#### 4.4.1 UserService 接口

```java
public interface UserService extends IService<User> {
    void register(RegisterRequest request);
    String login(LoginRequest request);
    UserVO getUserInfo(Long userId);
    void updateUserInfo(Long userId, UserUpdateRequest request);
    void updatePassword(Long userId, PasswordUpdateRequest request);
    IPage<UserVO> getUserList(PageQuery query);
    void updateUserStatus(Long userId, Integer status);
}
```

#### 4.4.2 CertificateService 接口

```java
public interface CertificateService extends IService<Certificate> {
    void verifyCertificate(Long userId, CertificateRequest request);
    CertificateVO getCertificateInfo(Long userId);
}
```

### 4.5 控制器层

#### 4.5.1 AuthController

```java
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    @PostMapping("/register")
    public Result<Void> register(@RequestBody RegisterRequest request);

    @PostMapping("/login")
    public Result<LoginResponse> login(@RequestBody LoginRequest request);
}
```

#### 4.5.2 UserController

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    @GetMapping("/profile")
    public Result<UserVO> getProfile();

    @PutMapping("/profile")
    public Result<Void> updateProfile(@RequestBody UserUpdateRequest request);

    @PutMapping("/password")
    public Result<Void> updatePassword(@RequestBody PasswordUpdateRequest request);

    @GetMapping("/list")
    @PreAuthorize("hasRole('ADMIN')")
    public Result<IPage<UserVO>> getUserList(PageQuery query);

    @PutMapping("/{id}/status")
    @PreAuthorize("hasRole('ADMIN')")
    public Result<Void> updateUserStatus(@PathVariable Long id, @RequestParam Integer status);

    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public Result<Void> deleteUser(@PathVariable Long id);
}
```

#### 4.5.3 CertificateController

```java
@RestController
@RequestMapping("/api/certificate")
public class CertificateController {
    @PostMapping
    public Result<Void> verifyCertificate(@RequestBody CertificateRequest request);

    @GetMapping
    public Result<CertificateVO> getCertificateInfo();
}
```

### 4.6 安全配置

#### 4.6.1 JwtUtil 工具类

```java
@Component
public class JwtUtil {
    public String generateToken(UserDetails userDetails);
    public String parseToken(String token);
    public boolean validateToken(String token);
    public String getUsernameFromToken(String token);
}
```

#### 4.6.2 JwtAuthenticationFilter

```java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain);
}
```

#### 4.6.3 SecurityConfig

```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    @Bean
    public PasswordEncoder passwordEncoder();

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http);

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config);
}
```

## 5. 前端架构设计

### 5.1 API 接口封装

#### 5.1.1 api/auth.js

```javascript
import request from '@/utils/request'

export function register(data) {
  return request({
    url: '/auth/register',
    method: 'post',
    data
  })
}

export function login(data) {
  return request({
    url: '/auth/login',
    method: 'post',
    data
  })
}
```

#### 5.1.2 api/user.js

```javascript
import request from '@/utils/request'

export function getProfile() {
  return request({
    url: '/user/profile',
    method: 'get'
  })
}

export function updateProfile(data) {
  return request({
    url: '/user/profile',
    method: 'put',
    data
  })
}

export function updatePassword(data) {
  return request({
    url: '/user/password',
    method: 'put',
    data
  })
}

export function getUserList(params) {
  return request({
    url: '/user/list',
    method: 'get',
    params
  })
}
```

#### 5.1.3 api/certificate.js

```javascript
import request from '@/utils/request'

export function verifyCertificate(data) {
  return request({
    url: '/certificate',
    method: 'post',
    data
  })
}

export function getCertificateInfo() {
  return request({
    url: '/certificate',
    method: 'get'
  })
}
```

### 5.2 页面组件

#### 5.2.1 Login.vue

登录页面，包含账号、密码输入框和登录按钮。

#### 5.2.2 Register.vue

注册页面，包含账号、密码、确认密码、名称、角色选择和注册按钮。

#### 5.2.3 Certification.vue

实名认证页面，包含证件号、真实姓名输入框和提交按钮。

#### 5.2.4 Profile.vue

个人中心页面，包含三个 Tab：
- 个人信息：显示和修改账号、名称、头像
- 修改密码：修改密码
- 实名认证：显示认证状态和信息

## 6. 业务流程

### 6.1 用户注册流程

1. 用户填写注册信息（账号、密码、确认密码、名称、角色）
2. 前端校验表单数据
3. 调用注册接口
4. 后端校验账号唯一性
5. 密码加密存储
6. 创建用户记录
7. 返回注册成功

### 6.2 用户登录流程

1. 用户填写登录信息（账号、密码）
2. 前端校验表单数据
3. 调用登录接口
4. 后端验证账号密码
5. 生成 JWT Token
6. 返回 Token 和用户信息
7. 前端存储 Token 到 localStorage
8. 跳转到首页

### 6.3 实名认证流程

1. 用户输入证件号和真实姓名
2. 调用实名认证接口
3. 后端在证件表中查找匹配的记录
4. 检查证件号和名称是否匹配
5. 检查证件号是否已被其他用户使用
6. 如果匹配且未被使用，更新用户表的 certificate_number 字段
7. 如果不匹配或已被使用，返回错误提示
8. 认证成功后，用户可以进行相应的业务操作

### 6.4 权限控制流程

1. 用户访问需要认证的接口
2. JWT 过滤器验证 Token
3. Token 有效：设置 SecurityContext，继续访问
4. Token 无效：返回 401，前端跳转登录页
5. 访问需要特定角色的接口
6. @PreAuthorize 注解验证角色
7. 角色匹配：继续访问
8. 角色不匹配：返回 403

## 7. 安全设计

### 7.1 密码安全

- 使用 BCrypt 加密存储密码
- 密码强度校验（8-20 位，至少包含字母和数字）
- 密码修改需要验证原密码

### 7.2 Token 安全

- JWT Token 有效期 7 天
- Token 存储在 localStorage
- 每次请求自动携带 Token
- Token 过期自动跳转登录页

### 7.3 输入验证

- 账号：4-20 位，字母数字下划线
- 密码：8-20 位，至少包含字母和数字
- 名称：2-20 位，中文或英文
- 证件号：使用预置的合法证件号

### 7.4 权限控制

- 路由守卫：未登录跳转登录页
- 接口权限：@PreAuthorize 注解
- 角色权限：ADMIN/USER/MERCHANT

### 7.5 证件号唯一性

- 证件号在证件表中唯一
- 证件号在用户表中唯一
- 一个证件号只能被一个用户使用
- 认证时需要检查证件号是否已被使用

## 8. 注意事项

1. **证件表预置数据**：证件表需要预置合法的证件号和对应的名称，用于实名认证验证
2. **证件号唯一性**：证件号必须全局唯一，一个证件号只能被一个用户使用
3. **实名认证**：商家和普通用户需要实名认证后才能进行相关业务操作
4. **管理员权限**：管理员不需要实名认证，但需要手动创建
5. **证件号格式**：严格按照规则生成，确保格式正确（MERCHANT001、USER001）
6. **角色选择**：用户注册时需要选择角色（USER 或 MERCHANT）
7. **状态管理**：用户状态需要及时更新
8. **日志记录**：重要操作需要记录日志（登录、注册、认证等）
9. **异常处理**：完善的异常处理和错误提示
10. **证件号匹配**：实名认证时，证件号和名称必须同时匹配才能认证成功

---

## 9. 开发进度记录

### 9.1 已完成功能

#### 后端实现
- ✅ 数据库配置与表结构设计（User 表）
- ✅ User 实体类与 UserMapper 接口
- ✅ UserService 接口及实现类
- ✅ JWT 工具类（JwtUtil）
- ✅ Spring Security 配置（SecurityConfig）
- ✅ JWT 认证过滤器（JwtAuthenticationFilter）
- ✅ CustomUserDetails 实现
- ✅ 全局异常处理器
- ✅ 统一返回结果类（Result）
- ✅ DTO 类设计（LoginRequest、RegisterRequest、UserVO、UserUpdateRequest、PasswordUpdateRequest）
- ✅ AuthController（注册、登录接口）
- ✅ UserController（用户信息、密码修改、用户列表、用户状态、删除用户接口）
- ✅ MyBatis-Plus 配置（分页插件、逻辑删除、自动填充）
- ✅ 跨域处理（CORS）
- ✅ Redis 序列化配置
- ✅ Knife4j 接口文档配置

#### 前端实现
- ✅ Axios 请求拦截器（统一处理 Token）
- ✅ Axios 响应拦截器（统一错误处理）
- ✅ Vue Router 路由配置
- ✅ Pinia 状态管理（用户信息、Token）
- ✅ Element Plus 全局样式配置
- ✅ 基础布局组件（MainLayout、AdminLayout、MerchantLayout）
- ✅ 登录页面组件（Login.vue）
  - 账号、密码、验证码输入
  - 验证码生成与刷新
  - 表单验证
  - 登录功能
  - 登录/注册切换
- ✅ 注册页面组件（集成在 Login.vue）
  - 账号、密码、确认密码、用户名、角色选择、验证码输入
  - 表单验证
  - 注册功能
  - 输入格式提示
- ✅ 首页组件（Home.vue）
  - Banner 展示
  - 功能特性展示
  - 商品展示
  - 数据统计
- ✅ API 接口封装（api/auth.js、api/user.js）
- ✅ Token 存储与自动续期
- ✅ 路由守卫（权限控制）

#### 测试与优化
- ✅ 用户注册流程测试
- ✅ 用户登录流程测试
- ✅ 用户管理功能测试（管理员）
- ✅ 错误提示信息优化
- ✅ 页面交互体验优化
- ✅ 验证码功能实现
- ✅ 输入格式提示优化

### 9.2 待完成功能

#### 后端实现
- ⭕ Certificate 实体类与 CertificateMapper 接口
- ⭕ CertificateService 接口及实现类
- ⭕ CertificateController（实名认证接口）
- ⭕ 证件表数据预置
- ⭕ 实名认证业务逻辑

#### 前端实现
- ⭕ 个人中心页面组件（Profile.vue）
  - 个人信息展示与修改
  - 密码修改
  - 实名认证信息展示
- ⭕ 用户管理页面组件（管理员）
- ⭕ 实名认证页面组件
- ⭕ API 接口封装（api/certificate.js）

#### 测试与优化
- ⭕ 实名认证流程测试
- ⭕ 个人信息修改测试
- ⭕ 密码修改测试
- ⭕ 权限控制完整测试
- ⭕ Token 过期处理测试
- ⭕ 异常情况处理测试

### 9.3 开发进度总结

**总体进度：约 70%**

- **后端开发进度：约 75%**
  - 基础架构：100% ✅
  - 用户模块：90% ✅
  - 实名认证模块：0% ⭕

- **前端开发进度：约 65%**
  - 基础架构：100% ✅
  - 认证页面：100% ✅
  - 首页：100% ✅
  - 个人中心：0% ⭕
  - 用户管理：0% ⭕
  - 实名认证：0% ⭕

- **测试与优化：约 50%**
  - 基础功能测试：100% ✅
  - 完整流程测试：0% ⭕
  - 用户体验优化：80% ✅

### 9.4 下一步计划

1. **优先级 1（高）**：完成实名认证功能
   - 创建 Certificate 实体类和 Mapper
   - 实现 CertificateService
   - 实现 CertificateController
   - 创建前端实名认证页面
   - 测试实名认证流程

2. **优先级 2（中）**：完善用户中心功能
   - 创建个人中心页面
   - 实现个人信息修改
   - 实现密码修改
   - 实现认证信息展示

3. **优先级 3（中）**：完善用户管理功能
   - 创建用户管理页面（管理员）
   - 实现用户列表展示
   - 实现用户状态修改
   - 实现用户删除功能

4. **优先级 4（低）**：系统优化与测试
   - 完整流程测试
   - 性能优化
   - 代码重构与优化
