# 商品模块设计方案

## 1. 模块概述

商品模块负责系统内非遗商品的维护、展示与详情查询，覆盖两类使用场景：

1. **管理端（管理员 / 商家）**：商品新增、编辑、删除、上下架、图片管理等后台能力。
2. **前台展示（所有登录用户）**：商品列表随机展示、商品详情查看。

本模块与用户模块通过 `product.merchant_id -> sys_user.id` 建立归属关系，不使用数据库外键，关系由业务层维护。

---

## 2. 需求分析

### 2.1 功能需求

1. **新增商品（ADMIN / MERCHANT）**
   - 仅管理员与商家可新增商品
   - 必填字段：商品名称 `name`、商品描述 `description`
   - 价格 `price`：创建时可不传，不传时按 `999` 处理
   - 归属 `merchant_id`：从当前登录用户获取（管理员/商家均可创建）
   - 其余字段（溯源码、二维码、3D 模型、图片等）允许后续编辑完善

2. **编辑商品（ADMIN / MERCHANT）**
   - 管理员可编辑所有商品
   - 商家仅可编辑自己创建的商品（按 `merchant_id` 校验归属）
   - 可编辑：名称、描述、价格、状态、溯源码相关字段、3D 模型地址、图片列表等

3. **删除商品（ADMIN / MERCHANT）**
   - 管理员可删除所有商品
   - 商家仅可删除自己创建的商品

4. **商品管理列表（ADMIN / MERCHANT）**
   - 支持分页查询
   - 支持按商品名称、上下架状态、创建时间范围筛选
   - 管理员可查看全部，商家仅查看自己商品

5. **前台商品页（所有登录用户）**
   - 新增独立商品页面，随机展示商品
   - 仅展示上架商品（`status = 1`）
   - 支持跳转商品详情页

6. **商品详情（所有登录用户）**
   - 展示商品基本信息、轮播图片、封面图、价格、描述
   - 若存在则展示：溯源码、溯源码二维码、3D 模型链接

### 2.2 非功能需求

1. **安全性**
   - 采用 JWT + Spring Security 认证
   - 管理端接口按角色（ADMIN/MERCHANT）授权
   - 商家操作校验商品归属（防越权）

2. **性能**
   - 管理列表分页查询
   - `merchant_id`、`status` 等字段建立索引
   - 前台随机列表可按需使用缓存（可选）

3. **可维护性**
   - 分层结构：Controller / Service / Mapper / Entity / DTO
   - 统一返回结构 `Result<T>`

---

## 3. 数据库设计

### 3.1 商品表 `product`

| 字段名       | 类型     | 长度 | 允许空 | 默认值            | 说明                               |
| ------------ | -------- | ---- | ------ | ----------------- | ---------------------------------- |
| id           | BIGINT   | -    | 否     | -                 | 商品ID，主键，自增                 |
| name         | VARCHAR  | 100  | 否     | -                 | 商品名称                           |
| description  | TEXT     | -    | 否     | -                 | 商品描述                           |
| price        | DECIMAL  | 10,2 | 否     | 999               | 商品价格（创建缺省按 999 处理）    |
| merchant_id  | BIGINT   | -    | 否     | -                 | 商家用户ID（关联 `sys_user.id`）   |
| trace_code   | VARCHAR  | 100  | 是     | NULL              | 商品溯源码（模拟功能）             |
| trace_qr_url | VARCHAR  | 255  | 是     | NULL              | 溯源码二维码图片URL（模拟功能）    |
| model_3d_url | VARCHAR  | 255  | 是     | NULL              | 商品 3D 模型地址（如 .glb/.gltf）  |
| status       | TINYINT  | 1    | 否     | 1                 | 商品状态：1-上架，0-下架           |
| create_time  | DATETIME | -    | 否     | CURRENT_TIMESTAMP | 创建时间                           |
| update_time  | DATETIME | -    | 否     | CURRENT_TIMESTAMP | 更新时间（自动更新）               |

**索引设计：**
- PRIMARY KEY (`id`)
- KEY `idx_merchant_id` (`merchant_id`)
- KEY `idx_status` (`status`)

### 3.2 商品图片表 `product_image`

| 字段名      | 类型     | 长度 | 允许空 | 默认值            | 说明                         |
| ----------- | -------- | ---- | ------ | ----------------- | ---------------------------- |
| id          | BIGINT   | -    | 否     | -                 | 商品图片ID，主键，自增       |
| product_id  | BIGINT   | -    | 否     | -                 | 商品ID                       |
| image_url   | VARCHAR  | 255  | 否     | -                 | 商品图片URL                  |
| sort_order  | INT      | -    | 否     | 0                 | 图片排序，数值越小越靠前     |
| is_cover    | TINYINT  | 1    | 否     | 0                 | 是否封面图：1-是，0-否       |
| create_time | DATETIME | -    | 否     | CURRENT_TIMESTAMP | 创建时间                     |

**索引设计：**
- PRIMARY KEY (`id`)
- KEY `idx_product_id` (`product_id`)
- KEY `idx_product_cover` (`product_id`, `is_cover`)

### 3.3 表关系说明

```
sys_user (1) —— (N) product
product (1) —— (N) product_image
```

### 3.4 用户地址表 `user_address`（收货地址）

地址属于可重复的业务数据，和用户是一对多关系，不建议把地址字段直接塞进 `sys_user`。

#### 3.4.1 表结构

| 字段名            | 类型           | 说明           |
| ----------------- | -------------- | -------------- |
| id                | BIGINT PK      | 地址ID         |
| user_id           | BIGINT         | 所属用户ID     |
| receiver_name     | VARCHAR(50)    | 收货人姓名     |
| receiver_phone    | VARCHAR(20)    | 收货人手机号   |
| province          | VARCHAR(50)    | 省             |
| city              | VARCHAR(50)    | 市             |
| district          | VARCHAR(50)    | 区             |
| detail_address    | VARCHAR(255)   | 详细地址       |
| is_default        | TINYINT(1)     | 是否默认地址   |
| status            | TINYINT(1)     | 状态：1-有效，0-删除 |
| create_time       | DATETIME       | 创建时间       |
| update_time       | DATETIME       | 更新时间       |

#### 3.4.2 索引设计

```sql
PRIMARY KEY (id)
KEY idx_user_id (user_id)
KEY idx_user_default (user_id, is_default)
```

#### 3.4.3 关系说明

- 逻辑关系：`sys_user (1) —— (N) user_address`
- 物理关系：`user_address.user_id -> sys_user.id`
- 是否加外键：不强制加外键，关联一致性由业务层保证

#### 3.4.4 业务规则

- 默认地址：设置某地址为默认时，先将该用户所有地址 `is_default = 0`，再将目标地址 `is_default = 1`
- 删除方式：不做物理删除，采用逻辑删除

```sql
UPDATE user_address
SET status = 0
WHERE id = ?
```

- 订单解耦：订单表不直接关联 `user_address`，订单中冗余收货人姓名、电话、完整地址字符串

#### 3.4.5 Controller / API 设计建议

```text
POST   /api/user/address                 新增地址
PUT    /api/user/address/{id}            修改地址
DELETE /api/user/address/{id}            删除地址（逻辑删除）
GET    /api/user/address/list            查询当前用户地址
PUT    /api/user/address/{id}/default    设为默认
```

访问控制：

- 必须登录
- `user_id` 从 JWT 中取，禁止前端传

---

## 4. 后端架构设计

### 4.1 实体层

#### 4.1.1 Product 实体类

```java
@Data
@TableName("product")
public class Product {
    @TableId(type = IdType.AUTO)
    private Long id;

    @TableField("name")
    private String name;

    @TableField("description")
    private String description;

    @TableField("price")
    private BigDecimal price;

    @TableField("merchant_id")
    private Long merchantId;

    @TableField("trace_code")
    private String traceCode;

    @TableField("trace_qr_url")
    private String traceQrUrl;

    @TableField("model_3d_url")
    private String model3dUrl;

    @TableField("status")
    private Integer status;

    @TableField("create_time")
    private LocalDateTime createTime;

    @TableField("update_time")
    private LocalDateTime updateTime;
}
```

#### 4.1.2 ProductImage 实体类

```java
@Data
@TableName("product_image")
public class ProductImage {
    @TableId(type = IdType.AUTO)
    private Long id;

    @TableField("product_id")
    private Long productId;

    @TableField("image_url")
    private String imageUrl;

    @TableField("sort_order")
    private Integer sortOrder;

    @TableField("is_cover")
    private Integer isCover;

    @TableField("create_time")
    private LocalDateTime createTime;
}
```

### 4.2 数据访问层

#### 4.2.1 ProductMapper

```java
@Mapper
public interface ProductMapper extends BaseMapper<Product> {
}
```

#### 4.2.2 ProductImageMapper

```java
@Mapper
public interface ProductImageMapper extends BaseMapper<ProductImage> {
}
```

### 4.3 数据传输层（DTO）

#### 4.3.1 新增商品请求

```java
@Data
public class ProductCreateRequest {
    @NotBlank(message = "商品名称不能为空")
    private String name;

    @NotBlank(message = "商品描述不能为空")
    private String description;

    private BigDecimal price;
}
```

#### 4.3.2 更新商品请求

```java
@Data
public class ProductUpdateRequest {
    private String name;
    private String description;
    private BigDecimal price;
    private String traceCode;
    private String traceQrUrl;
    private String model3dUrl;
    private Integer status;
}
```

#### 4.3.3 商品信息返回

```java
@Data
public class ProductVO {
    private Long id;
    private String name;
    private String description;
    private BigDecimal price;
    private Long merchantId;
    private Integer status;
    private String traceCode;
    private String traceQrUrl;
    private String model3dUrl;
    private String coverImageUrl;
    private List<String> imageUrls;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
```

### 4.4 业务逻辑层

#### 4.4.1 ProductService 接口

```java
public interface ProductService extends IService<Product> {
    Long createProduct(Long operatorUserId, ProductCreateRequest request);
    void updateProduct(Long operatorUserId, Long productId, ProductUpdateRequest request);
    void deleteProduct(Long operatorUserId, Long productId);
    Page<ProductVO> getManageProductPage(Long operatorUserId, PageQuery query, String keyword, Integer status);
    ProductVO getProductDetail(Long productId);
    List<ProductVO> getRandomOnSaleProducts(Integer count);
}
```

### 4.5 控制器层

#### 4.5.1 ProductController（管理端）

```java
@RestController
@RequestMapping("/api/products")
public class ProductController {

    @PostMapping
    @PreAuthorize("hasRole('ADMIN') or hasRole('MERCHANT')")
    public Result<Long> create(@Valid @RequestBody ProductCreateRequest request);

    @PutMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or hasRole('MERCHANT')")
    public Result<Void> update(@PathVariable Long id, @RequestBody ProductUpdateRequest request);

    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or hasRole('MERCHANT')")
    public Result<Void> delete(@PathVariable Long id);

    @GetMapping
    @PreAuthorize("hasRole('ADMIN') or hasRole('MERCHANT')")
    public Result<Page<ProductVO>> page(PageQuery query, @RequestParam(required = false) String keyword,
                                        @RequestParam(required = false) Integer status);
}
```

#### 4.5.2 ShopProductController（前台展示）

```java
@RestController
@RequestMapping("/api/shop")
public class ShopProductController {

    @GetMapping("/recommend")
    public Result<List<ProductVO>> recommend(@RequestParam(defaultValue = "20") Integer count);

    @GetMapping("/products/{id}")
    public Result<ProductVO> detail(@PathVariable Long id);
}
```

---

## 5. 前端架构设计

### 5.1 API 接口封装

建议新增：

- `src/api/product.js`：管理端商品 CRUD
- `src/api/shop.js`：前台商品列表/详情

调用方式保持与现有 `src/api/auth.js` 一致，统一使用 `@/utils/request`，并使用 `/api` 前缀。

### 5.2 页面组件

1. **管理端商品管理页**
   - `src/views/admin/Products.vue`：管理员商品管理
   - `src/views/merchant/Products.vue`：商家商品管理

2. **前台商品页（新增）**
   - 新增 `src/views/ShopProducts.vue`（或同等命名）用于商品随机展示
   - 路由建议指向 `/products`，并从首页“查看更多”入口跳转

3. **商品详情页**
   - `src/views/ProductDetail.vue`：展示商品详情、图片、溯源与 3D 资源（如有）

---

## 6. 业务流程

### 6.1 新增商品流程（ADMIN / MERCHANT）

1. 前端提交新增商品表单（name、description、price 可选）
2. 后端校验登录态与角色
3. 从登录态获取 `operatorUserId` 并写入 `merchant_id`
4. 若 `price` 为空则按 `999` 处理
5. 保存商品记录，返回商品 ID

### 6.2 商家操作归属校验（MERCHANT）

1. 商家请求更新/删除商品
2. 后端查询商品 `merchant_id`
3. 若 `merchant_id != operatorUserId` 则拒绝（403/业务异常）

### 6.3 前台随机展示流程

1. 前端进入商品页，调用推荐接口
2. 后端按 `status = 1` 过滤并随机返回指定数量商品
3. 前端渲染商品卡片，点击进入详情页

---

## 7. 安全设计

### 7.1 访问控制

- 管理端接口：`ADMIN / MERCHANT`
- 前台展示接口：允许所有登录用户访问

### 7.2 越权防护

- 商家角色：对商品更新/删除必须校验 `merchant_id` 归属
- 管理员角色：允许对任意商品操作

### 7.3 输入验证

- 创建时：`name`、`description` 非空；`price` 非负（可选）
- 更新时：字段可选但需做合法性校验（长度、价格范围等）

---

## 8. 注意事项

1. **字段一致性**：前端展示字段以数据库为准，当前版本不引入库存、销量、分类等字段。
2. **图片与封面**：列表页封面图优先取 `product_image.is_cover = 1`，无封面则取最小 `sort_order` 图片或占位图。
3. **时间字段**：`create_time/update_time` 推荐由数据库默认值维护；若后续需要 MyBatis-Plus 自动填充，可在 `MetaObjectHandler` 中补充 `createTime` 填充规则。
4. **不使用外键**：商品与用户、图片的关联一致性由业务层保证（删除商品时同步删除图片记录）。

---

## 9. 开发进度记录

### 9.1 已完成

- ✅ 商品模块数据库表设计（`product`、`product_image`）
- ✅ 商品模块建表与模拟数据 SQL（`backend/src/main/resources/sql/product.sql`）

### 9.2 待完成

- ⭕ 后端商品模块实体 / DTO / Service / Controller
- ⭕ 前端前台商品页（随机展示）与路由调整
- ⭕ 管理端商品管理页对接后端接口
- ⭕ 商品详情页对接后端接口（图片、溯源、3D 资源）
